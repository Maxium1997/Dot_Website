{% extends "base.html" %}

{% block subtitle %}
Coast Guard Mart
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'coast_guard_mart:product_list' %}">Coast Guard Mart</a></li>
<li class="breadcrumb-item"><a href="{% url 'coast_guard_mart:order_list' %}">消費紀錄</a></li>
<li class="breadcrumb-item active" aria-current="page">訂單詳情 - {{ tx.order_id }}</li>
{% endblock %}

{% block body %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-receipt me-2"></i>訂單編號：{{ tx.order_id }}</h5>

                        {# 根據狀態顯示不同的 Badge #}
                        {% if tx.status == 'PREPARING' %}
                            <span class="badge bg-warning text-dark px-3 py-2"><i class="bi bi-box-seam me-1"></i>備貨中</span>
                        {% elif tx.status == 'COMPLETED' %}
                            <span class="badge bg-success px-3 py-2"><i class="bi bi-check-circle me-1"></i>交易完成</span>
                        {% elif tx.status == 'CANCELLED' %}
                            <span class="badge bg-secondary px-3 py-2"><i class="bi bi-x-circle me-1"></i>訂單已取消</span>
                        {% endif %}
                    </div>
                </div>

                <div class="card-body">
                    <div class="row mb-4 bg-light mx-0 py-3 rounded">
                        <div class="col-sm-6">
                            <p class="text-muted small mb-1">下單時間</p>
                            <p class="fw-bold mb-0">{{ tx.timestamp|date:"Y-m-d H:i:s" }}</p>
                        </div>
                        <div class="col-sm-6 text-sm-end mt-3 mt-sm-0">
                            <p class="text-muted small mb-1">使用額度</p>
                            <p class="h4 text-danger fw-bold mb-0">NT$ {{ tx.amount|floatformat:0 }}</p>
                        </div>
                    </div>

                    <h6 class="fw-bold mb-3"><i class="bi bi-bag-check me-2"></i>訂購商品內容</h6>
                    <div class="border rounded p-4 mb-4 bg-white">
                        {# 使用 linebreaksbr 保持原本 checkout 存入的換行格式 #}
                        <div class="order-content" style="line-height: 2;">
                            {{ tx.description|linebreaksbr }}
                        </div>
                    </div>

                    {% if tx.status == 'COMPLETED' %}
                    <div class="alert alert-success border-0 small">
                        <i class="bi bi-info-circle me-1"></i> 此訂單已完成出貨，如有任何問題請聯繫管理員。
                    </div>
                    {% elif tx.status == 'CANCELLED' %}
                    <div class="alert alert-light border small text-muted">
                        <i class="bi bi-info-circle me-1"></i> 此訂單已於 {{ tx.updated_at|date:"Y-m-d H:i" }} 取消，點數已全額退回您的帳戶。
                    </div>
                    {% endif %}
                </div>

                <div class="card-footer bg-white text-center py-4 border-top-0">
                    <div class="d-grid gap-2 d-md-block">
                        <a href="{% url 'coast_guard_mart:order_list' %}" class="btn btn-secondary shadow-sm">
                            <i class="bi bi-arrow-left"></i> 返回消費紀錄
                        </a>
                        {% if user.is_staff %}
                        <a href="{% url 'coast_guard_mart:staff_order_dashboard' %}" class="btn btn-danger shadow-sm">
                            <i class="bi bi-shield-lock"></i> 返回訂單管理儀表板
                        </a>
                        {% endif %}

                        {# 只有備貨中狀態顯示取消按鈕 #}
                        {% if tx.status == 'PREPARING' %}
                        <form action="{% url 'coast_guard_mart:cancel_order' tx.order_id %}" method="POST"
                              onsubmit="return confirm('確定要取消此訂單並退回點數嗎？');" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger px-4">
                                <i class="bi bi-trash"></i> 取消此訂單
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center my-4 p-3 border rounded bg-light">
            <h6><i class="bi bi-qr-code-scan me-2"></i>領貨核銷 QR Code</h6>
            {% if tx.status == "PREPARING" %}
                <img src="{% url 'coast_guard_mart:generate_order_qrcode' tx.order_id %}"
                     alt="Order QR Code" class="img-fluid" style="max-width: 200px;">
                <p class="small text-muted mt-2">請於領取商品時出示此碼給工作人員掃描</p>
            {% else %}
                <div class="py-4 text-secondary">
                    <i class="bi bi-check-circle-fill display-4"></i>
                    <p>訂單已核銷完成</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .order-content {
        font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        color: #333;
    }
</style>
{% endblock %}