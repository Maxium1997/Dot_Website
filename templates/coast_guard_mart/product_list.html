{% extends "base.html" %}

{% block subtitle %}
Coast Guard Mart
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active" aria-current="page">Coast Guard Mart</li>
{% endblock %}

{% block body %}
<div class="container mt-4">
    <div class="row">
        {% if user.is_authenticated %}
            <div class="alert {% if user.credits.all %}alert-info{% else %}alert-warning{% endif %} d-flex justify-content-between align-items-center shadow-sm mb-4">
                <div>
                    {% with current_credit=user.credits.first %}
                        {% if current_credit %}
                            <i class="bi bi-wallet2 me-2"></i>
                            <strong>您的年度福利金餘額：</strong>
                            <span class="fs-5 text-primary fw-bold">NT$ {{ current_credit.balance|floatformat:0 }}</span>
                            <small class="text-muted ms-2">(有效期至: {{ current_credit.end_date|date:"Y/m/d" }})</small>
                        {% else %}
                            <i class="bi bi-gift me-2"></i>
                            <strong>您尚未領取本年度 NT$ 3,000 福利金！</strong>
                        {% endif %}
                    {% endwith %}
                </div>

                {% if not user.credits.all %}
                    <a href="{% url 'coast_guard_mart:claim_credit' %}" class="btn btn-warning fw-bold shadow-sm">
                        立即核對並領取
                    </a>
                {% endif %}
            </div>
        {% else %}
            <div class="alert alert-secondary mb-4">
                <i class="bi bi-info-circle me-2"></i> 登入後即可領取並使用年度福利金。
                <a href="{% url 'login' %}">
                    點擊立即登入
                </a>
            </div>
        {% endif %}

       <div class="d-flex justify-content-start mb-3 gap-2">
            <a href="{% url 'coast_guard_mart:cart_detail' %}" class="btn btn-outline-dark position-relative">
                <i class="bi bi-cart3"></i> 檢視購物車
                {% if request.session.cart %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        {{ request.session.cart.keys|length }}
                        <span class="visually-hidden">商品數量</span>
                    </span>
                {% endif %}
            </a>

            <a href="{% url 'coast_guard_mart:order_list' %}" class="btn btn-outline-info">
                <i class="bi bi-card-list"></i> 檢視訂單
            </a>

           {% if user.is_staff %}
            <a href="{% url 'coast_guard_mart:staff_order_dashboard' %}" class="btn btn-outline-danger shadow-sm">
                <i class="bi bi-shield-lock"></i> 管理訂單
            </a>

            <a href="{% url 'coast_guard_mart:staff_whitelist_manager' %}" class="btn btn-outline-danger shadow-sm">
                <i class="bi bi-shield-lock"></i> 管理白名單
            </a>

            {% endif %}
        </div>

        <div class="col-md-3">
            <h3>分類</h3>
            <ul class="list-group">
                <li class="list-group-item {% if not category %}active{% endif %}">
                    <a href="{% url 'coast_guard_mart:product_list' %}"
                       class="text-decoration-none {% if not category %}text-white{% else %}text-dark{% endif %} d-block">
                       全部
                    </a>
                </li>

                {% for c in categories %}
                <li class="list-group-item {% if category.slug == c.slug %}active{% endif %}">
                    <a href="{% url 'coast_guard_mart:product_list_by_category' c.slug %}"
                       class="text-decoration-none {% if category.slug == c.slug %}text-white{% else %}text-dark{% endif %} d-block">
                        {{ c.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="col-md-9">
            <h2>{% if category %}{{ category.name }}{% else %}所有產品{% endif %}</h2>
            <div class="row">
                {% for product in products %}
                <div class="col-lg-3 col-md-4 col-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <a href="{% url 'coast_guard_mart:product_detail' product.id %}">
                            <div class="square-img-container">
                                <img src="{{ product.image.url }}"
                                     class="card-img-top card-img-square"
                                     alt="{{ product.name }}">
                            </div>
                        </a>

                        <div class="card-body p-2 p-md-3">
                            <a href="{% url 'coast_guard_mart:product_detail' product.id %}" class="text-decoration-none text-dark">
                                <h5 class="card-title text-truncate mb-1" style="font-size: 0.9rem; font-weight: bold;">
                                    {{ product.name }}
                                </h5>
                            </a>

                            <p class="card-text text-muted d-none d-md-block">
                                {{ product.description|striptags|truncatewords:5 }}
                            </p>
                            <p class="h6 text-primary mb-0">NT$ {{ product.price }}</p>
                        </div>

                        <div class="card-footer bg-white border-top-0 p-2">
                            <a href="{% url 'coast_guard_mart:product_detail' product.id %}"
                               class="btn btn-sm btn-outline-dark w-100">詳情</a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p>目前沒有產品上架。</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
    /* 強制圖片容器為正方形 */
    .card-img-square {
        width: 100%;
        aspect-ratio: 1 / 1; /* 設定比例為 1:1 */
        object-fit: cover;   /* 關鍵：自動裁切多餘部分，保持比例不變形 */
        object-position: center; /* 確保裁切時以中心為主 */
    }

    /* 額外優化：防止卡片標題過長換行破壞版面 */
    .text-truncate {
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .alert {
        border: none;
        border-left: 5px solid;
    }
    .alert-info {
        border-left-color: #0dcaf0;
        background-color: #f0faff;
    }
    .alert-warning {
        border-left-color: #ffc107;
        background-color: #fff9e6;
    }
</style>
{% endblock %}