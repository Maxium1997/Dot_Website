{% extends "base.html" %}

{% block subtitle %}
Coast Guard Mart
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'coast_guard_mart:product_list' %}">Coast Guard Mart</a></li>
<li class="breadcrumb-item active" aria-current="page">White List Manager</li>
{% endblock %}

{% block body %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="bi bi-people-fill me-2"></i>白名單管理</h3>
        <div>
            <a href="{% url 'coast_guard_mart:staff_whitelist_export' %}" class="btn btn-outline-primary me-2">
                <i class="bi bi-file-earmark-arrow-up"></i> 匯出 Excel
            </a>

            <a href="{% url 'coast_guard_mart:staff_whitelist_import' %}" class="btn btn-outline-success me-2">
                <i class="bi bi-file-earmark-arrow-down"></i> 批次匯入
            </a>
            <a href="{% url 'coast_guard_mart:staff_whitelist_add' %}" class="btn btn-primary">新增人員</a>
        </div>
    </div>

    <form method="get" class="mb-3">
        <div class="input-group">
            <input type="text" name="q" class="form-control" placeholder="搜尋姓名、身分證或單位..." value="{{ query }}">
            <button class="btn btn-dark" type="submit">搜尋</button>
        </div>
    </form>

    <div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>姓名</th>
                    <th>身分證</th>
                    <th>生日</th>
                    <th>所屬單位</th>
                    <th>綁定帳號</th> <th>狀態</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for m in whitelist %}
                <tr>
                    <td>{{ m.name }}</td>
                    <td><code>{{ m.id_number }}</code></td>
                    <td>{{ m.birthday|date:"Y-m-d" }}</td>
                    <td class="small">
                        <div class="text-dark fw-bold">{{ m.unit.name }}</div>
                        <div class="text-muted" style="font-size: 0.7rem;">{{ m.unit.full_path }}</div>
                    </td>
                    <td>
                        {% if m.claimed_by %}
                            <span class="text-primary fw-bold">
                                <i class="bi bi-person-check-fill me-1"></i>{{ m.claimed_by.username }}
                            </span>
                            {% if m.claimed_by.get_full_name %}
                                <small class="text-muted">({{ m.claimed_by.get_full_name }})</small>
                            {% endif %}
                        {% else %}
                            <span class="text-muted italic">---</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if m.is_claimed %}
                            <span class="badge bg-success">已領取</span>
                        {% else %}
                            <span class="badge bg-warning text-dark">未領取</span>
                        {% endif %}
                    </td>
                    <td>
                        <form action="{% url 'coast_guard_mart:staff_whitelist_delete' %}" method="post" onsubmit="return confirm('確定要移除此人員嗎？');" style="display:inline;">
                            {% csrf_token %}
                            <input type="hidden" name="member_id" value="{{ m.id }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger">移除</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="text-center py-4">查無資料</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
</div>
{% endblock %}
